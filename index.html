<!DOCTYPE html>
<html>
<head>
<title>AST playground</title>
<style>
textarea { display: block; box-sizing: border-box; width: 100%; height: 150px; font-size: 20px; }
</style>
<body>
<textarea id="code" autofocus># type ruby code here
3 + 2</textarea>
<textarea id="json"></textarea>
<script src="parse.js" type="text/javascript"></script>
<script>
;(function(){

function $ (id) { return document.getElementById(id) }

var
  codeNode = $('code'),
  jsonNode = $('json')

var parser = new RubyParser()
parser.setFilename('(textarea)')
parser.print = print

var stderr = ''
function print (msg)
{
  stderr += msg
}

var lastCode = ''
function compile ()
{
  // don't recompile the same code
  var codeToCompile = codeNode.value
  if (codeToCompile == lastCode)
    return
  lastCode = codeToCompile
  
  // reset the stderr buffer preparing it for new errors stream
  stderr = ''
  // reset the stdout :)
  jsonNode.value = ''
  
  // actually compile the ruby code
  var ast = parser.parse(codeToCompile)
  // render all the warnings and errors
  jsonNode.value += stderr
  
  if (ast === false) // error
  {
    // errors are already printed
    // so do nothing and return
    return
  }
  
  // convert typed nodes to plain arrays
  var plainArrays = RubyParser.Builder.toPlain(ast)
  // render the tree structure with good old JSON
  jsonNode.value = JSON.stringify(plainArrays)
}

function delayedCompile () { window.setTimeout(compile) }
codeNode.addEventListener('keyup', delayedCompile, false)
codeNode.addEventListener('keydown', delayedCompile, false)
codeNode.addEventListener('keypress', delayedCompile, false)

// compile the default code placed in textarea's HTML code
compile()

})();
</script>